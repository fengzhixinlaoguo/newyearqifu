<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>æ–°æ˜¥ç¥ˆç¦ | çµç­¾æŒ‡è·¯</title>

    <!-- å­—ä½“ä¸å›¾æ ‡ -->
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=Ma+Shan+Zheng&family=Long+Cang&family=Zhi+Mang+Xing&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


    <!-- å›¾åƒç”Ÿæˆä¸äºŒç»´ç åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- AI APIè°ƒç”¨æ¨¡å— -->
    <script src="ai-api.js"></script>

    <!-- æ ·å¼é…ç½® -->
    <style>
        :root {
            --red-main: #c02c38;
            /* æ•…å®«çº¢ */
            --red-deep: #7a1a23;
            /* æ·±èƒ­è„‚ */
            --gold-main: #e0b46a;
            /* æ³¥é‡‘ */
            --paper-light: #fdfbf7;
            /* å®£çº¸ç™½ */
            --ink-color: #2b2b2b;
        }

        body {
            background-color: var(--red-deep);
            background-image:
                radial-gradient(circle at 50% 20%, #d63f4b 0%, #7a1a23 80%),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e0b46a' fill-opacity='0.12'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            font-family: 'Noto Serif SC', serif;
            color: var(--paper-light);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* å­—ä½“ç‰¹æ•ˆ */
        .font-calligraphy {
            font-family: 'Ma Shan Zheng', cursive;
        }

        .font-poem {
            font-family: 'Long Cang', cursive;
        }

        .font-seal {
            font-family: 'Zhi Mang Xing', cursive;
        }

        /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
        .glass-card {
            background: rgba(122, 26, 35, 0.45);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(224, 180, 106, 0.3);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
        }

        /* èŠ‚æ—¥ç¯ç¬¼åŠ¨ç”» */
        .lantern {
            position: absolute;
            top: -20px;
            width: 80px;
            height: 100px;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MCAxMDAiPjxlbGxpcHNlIGN4PSI0MCIgY3k9IjUwIiByeD0iMzUiIHJ5PSI0NSIgZmlsbD0iI2MwMmMzOCIgc3Ryb2tlPSIjZTBiNDZhIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNDAgNSBMNDAgOTUiIHN0cm9rZT0iI2UwYjQ2YSIgc3Ryb2tlLXdpZHRoPSIxIiBvcGFjaXR5PSIwLjUiLz48cmVjdCB4PSIzMCIgeT0iMCIgd2lkdGg9IjIiIGhlaWdodD0iMTAiIGZpbGw9IiMmYjJiMmIiLz48cmVjdCB4PSIzMCIgeT0iOTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIxMCIgZmlsbD0iIzJiMmIyYiIvPjwvc3ZnPg==') no-repeat center;
            background-size: contain;
            transform-origin: top center;
            animation: swing 4s ease-in-out infinite alternate;
            z-index: 5;
            filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.4));
        }

        .lantern::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            width: 4px;
            height: 30px;
            background: #e0b46a;
            transform: translateX(-50%);
            box-shadow: 0 0 8px #e0b46a;
        }

        @keyframes swing {
            from {
                transform: rotate(-6deg);
            }

            to {
                transform: rotate(6deg);
            }
        }

        /* --- æ–°ç‰ˆæ¢…èŠ±ç«¹ç­’ --- */
        .bamboo-cylinder-wrapper {
            position: relative;
            width: 160px;
            height: 240px;
            transform-style: preserve-3d;
        }

        .bamboo-body {
            position: absolute;
            inset: 0;
            background: linear-gradient(92deg, #5c4033 0%, #8b5a2b 30%, #a06a38 50%, #8b5a2b 70%, #5c4033 100%);
            border-radius: 10px 10px 40px 40px;
            box-shadow:
                inset 0 0 30px rgba(0, 0, 0, 0.8),
                0 20px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid #3e2723;
            overflow: hidden;
            z-index: 2;
        }

        .bamboo-joint {
            position: absolute;
            width: 100%;
            height: 4px;
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 1px 1px rgba(255, 255, 255, 0.1);
            z-index: 3;
        }

        .bamboo-top {
            position: absolute;
            top: -15px;
            left: 0;
            width: 100%;
            height: 30px;
            background: #3e2723;
            border-radius: 50%;
            border: 4px solid #8b5a2b;
            box-shadow: inset 0 10px 10px rgba(0, 0, 0, 0.9);
            z-index: 1;
        }

        .plum-decor {
            position: absolute;
            bottom: 10px;
            right: -10px;
            width: 100%;
            height: 60%;
            z-index: 4;
            opacity: 0.9;
            filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.3));
        }

        @keyframes shake-hard {

            0%,
            100% {
                transform: rotate(0deg) translateY(0);
            }

            10% {
                transform: rotate(-5deg) translateY(-5px);
            }

            20% {
                transform: rotate(5deg) translateY(5px);
            }

            30% {
                transform: rotate(-5deg) translateY(-5px);
            }

            40% {
                transform: rotate(5deg) translateY(5px);
            }

            50% {
                transform: rotate(-5deg) translateY(-5px);
            }

            60% {
                transform: rotate(5deg) translateY(5px);
            }

            70% {
                transform: rotate(-3deg) translateY(-3px);
            }

            80% {
                transform: rotate(3deg) translateY(3px);
            }
        }

        .animate-shake-hard {
            animation: shake-hard 0.6s infinite;
        }

        @keyframes stick-fly {
            0% {
                transform: translateY(0) scale(0.8);
                opacity: 0;
            }

            60% {
                transform: translateY(-160px) rotate(5deg) scale(1.05);
                opacity: 1;
            }

            100% {
                transform: translateY(-140px) rotate(8deg) scale(1);
                opacity: 1;
            }
        }

        .stick-appear {
            animation: stick-fly 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        #share-card-container {
            font-family: 'Noto Serif SC', serif;
            background: radial-gradient(circle at 50% 30%, #d63f4b 0%, #991b1b 60%, #450a0a 100%);
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            color: #fef3c7;
        }

        .share-ratio-9-16 {
            width: 375px;
            height: 667px;
        }

        .share-ratio-3-4 {
            width: 450px;
            height: 600px;
        }

        .share-ratio-1-1 {
            width: 500px;
            height: 500px;
        }

        .poster-bg-texture {
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23fcd34d' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            z-index: 0;
            opacity: 0.6;
        }

        .poster-border-outer {
            position: absolute;
            inset: 12px;
            border: 2px solid #b45309;
            z-index: 10;
            pointer-events: none;
            border-radius: 2px;
        }

        .poster-border-inner {
            position: absolute;
            inset: 18px;
            border: 1px solid #fcd34d;
            z-index: 10;
            pointer-events: none;
            opacity: 0.8;
        }

        .poster-corner {
            position: absolute;
            width: 24px;
            height: 24px;
            border: 3px solid #fcd34d;
            z-index: 11;
        }

        .c-tl {
            top: 12px;
            left: 12px;
            border-right: none;
            border-bottom: none;
        }

        .c-tr {
            top: 12px;
            right: 12px;
            border-left: none;
            border-bottom: none;
        }

        .c-bl {
            bottom: 12px;
            left: 12px;
            border-right: none;
            border-top: none;
        }

        .c-br {
            bottom: 12px;
            right: 12px;
            border-left: none;
            border-top: none;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* å·¦ä¸‹è§’ UI */
        .bottom-ui {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 50;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            transition: all 0.3s;
        }

        .user-pill {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            padding: 6px 14px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e0b46a;
            font-size: 12px;
        }

        .btn-gold {
            background: linear-gradient(to right, #e0b46a, #d4a04d);
            color: #3e2723;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(224, 180, 106, 0.4);
            transition: all 0.3s;
        }

        .btn-gold:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .writing-vertical {
            writing-mode: vertical-rl;
            text-orientation: upright;
        }

        /* --- æ¯”ä¾‹è‡ªé€‚åº”é€‚é… --- */

        /* 9:16 æ‰‹æœºæµ·æŠ¥åŸºç¡€é€‚é… */
        .share-ratio-9-16 .share-content-main {
            padding: 1.25rem !important;
        }

        .share-ratio-9-16 .header-area {
            margin-bottom: 0.25rem !important;
            padding-top: 0.25rem !important;
        }

        .share-ratio-9-16 .content-middle-area {
            margin-top: -2rem !important;
        }

        .share-ratio-9-16 #poster-level {
            font-size: 3.2rem !important;
        }

        .share-ratio-9-16 .level-title-area {
            margin-bottom: 1rem !important;
        }

        .share-ratio-9-16 .poem-container {
            height: 10rem !important;
            margin-bottom: 1rem !important;
            gap: 1.5rem !important;
        }

        .share-ratio-9-16 .font-poem {
            font-size: 1.2rem !important;
        }

        .share-ratio-9-16 .wish-box {
            padding: 0.6rem 1rem !important;
            max-width: 90% !important;
        }

        .share-ratio-9-16 #poster-wish {
            font-size: 0.85rem !important;
            display: -webkit-box;
            line-clamp: 3;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .share-ratio-9-16 .footer-area {
            padding-top: 0.5rem !important;
            padding-bottom: 0.25rem !important;
            margin-top: 0 !important;
        }

        /* 3:4 å°çº¢ä¹¦æ¯”ä¾‹ */
        .share-ratio-3-4 .share-content-main {
            padding: 1rem !important;
        }

        .share-ratio-3-4 .header-area {
            margin-bottom: 0.25rem !important;
            padding-top: 0.15rem !important;
        }

        .share-ratio-3-4 #poster-level {
            font-size: 2.6rem !important;
        }

        .share-ratio-3-4 .level-title-area {
            margin-bottom: 0.5rem !important;
        }

        .share-ratio-3-4 .content-middle-area {
            margin-top: -3.5rem !important;
        }

        .share-ratio-3-4 .poem-container {
            height: 7rem !important;
            margin-bottom: 1rem !important;
            gap: 1.25rem !important;
        }

        .share-ratio-3-4 .font-poem {
            font-size: 0.9rem !important;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .share-ratio-3-4 .wish-box {
            padding: 0.5rem 0.75rem !important;
            max-width: 90% !important;
        }

        .share-ratio-3-4 #poster-wish {
            font-size: 0.8rem !important;
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .share-ratio-3-4 .poster-analysis {
            font-size: 0.65rem !important;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .share-ratio-3-4 .footer-area {
            padding-top: 0.5rem !important;
            padding-bottom: 0.15rem !important;
        }

        /* 1:1 æœ‹å‹åœˆæ¯”ä¾‹ */
        .share-ratio-1-1 .share-content-main {
            padding: 1rem !important;
        }

        .share-ratio-1-1 .header-area {
            margin-bottom: 0.1rem !important;
            padding-top: 0.15rem !important;
        }

        .share-ratio-1-1 .content-middle-area {
            margin-top: -5.5rem !important;
        }

        .share-ratio-1-1 #poster-level {
            font-size: 2rem !important;
        }

        .share-ratio-1-1 .level-title-area {
            margin-bottom: 0.25rem !important;
        }

        .share-ratio-1-1 .poem-container {
            height: 6.8rem !important;
            margin-bottom: 0.4rem !important;
            gap: 1rem !important;
        }

        .share-ratio-1-1 .poem-col-2 {
            padding-left: 1rem !important;
        }

        .share-ratio-1-1 .font-poem {
            font-size: 0.85rem !important;
            line-height: 1.1 !important;
        }

        .share-ratio-1-1 .wish-box {
            padding: 0.5rem 0.75rem !important;
            max-width: 88% !important;
        }

        .share-ratio-1-1 .wish-box .mb-3 {
            margin-bottom: 0.25rem !important;
        }

        .share-ratio-1-1 #poster-wish {
            font-size: 0.8rem !important;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .share-ratio-1-1 .poster-analysis {
            font-size: 0.65rem !important;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .share-ratio-1-1 .footer-area {
            padding-top: 0.75rem !important;
            padding-bottom: 0.25rem !important;
            margin-top: -0.5rem !important;
        }

        .share-ratio-1-1 #qrcode-box {
            width: 2.5rem !important;
            height: 2.5rem !important;
        }

        .share-ratio-1-1 #qrcode-box canvas,
        .share-ratio-1-1 #qrcode-box img {
            width: 100% !important;
            height: 100% !important;
        }

        .share-ratio-1-1 .footer-title {
            font-size: 1rem !important;
        }

        .share-ratio-1-1 .footer-subtitle {
            font-size: 7px !important;
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center">

    <!-- è£…é¥° -->
    <div class="lantern" style="left: 10%; animation-delay: 0s;"></div>
    <div class="lantern" style="left: 80%; animation-delay: 1.5s; transform: scale(0.9);"></div>
    <div id="snow-container" class="fixed inset-0 pointer-events-none z-0"></div>

    <main
        class="relative z-10 w-full max-w-lg px-6 py-6 flex flex-col items-center min-h-[90vh] justify-center transition-all duration-500"
        id="main-stage">
        <header class="text-center mb-10">
            <h1 class="font-calligraphy text-6xl text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 to-yellow-500 drop-shadow-lg"
                style="text-shadow: 0 4px 10px rgba(122, 26, 35, 0.6);">
                æ–°å¹´ç¥ˆç¦
            </h1>
            <div class="mt-4 flex items-center justify-center gap-3 opacity-90">
                <span class="w-8 h-[1px] bg-yellow-400/50"></span>
                <span class="text-yellow-200 font-serif tracking-[0.4em] text-sm">çµç­¾æŒ‡è·¯ Â· é‡äº‹ä¸å†³</span>
                <span class="w-8 h-[1px] bg-yellow-400/50"></span>
            </div>
        </header>

        <div id="input-box" class="w-full glass-card rounded-2xl p-6 transition-all duration-500 transform">
            <div class="mb-6 relative">
                <label
                    class="block text-center text-yellow-100 text-sm font-serif mb-3 tracking-widest opacity-80">é»˜å¿µå¿ƒä¸­æ‰€æ±‚
                    Â· è¯šå¿ƒç¥·å‘Š</label>
                <textarea id="wish-input"
                    class="w-full bg-red-950/40 border border-yellow-600/30 rounded-xl p-5 text-yellow-50 placeholder-yellow-100/20 focus:outline-none focus:border-yellow-500/50 transition resize-none text-center font-serif text-lg h-32"
                    placeholder="ä¾‹å¦‚ï¼šæ–°çš„ä¸€å¹´ï¼Œæ„¿å®¶äººå®‰åº·ï¼Œäº‹ä¸šé¡ºé‚..."></textarea>
            </div>

            <div class="flex flex-wrap justify-center gap-2 mb-8">
                <button onclick="setWish('æ„¿å…¨å®¶å¹³å®‰å¥åº·ï¼Œæ— ç—…æ— ç¾ï¼Œå–œä¹é•¿å®‰')"
                    class="px-3 py-1.5 bg-red-900/30 border border-red-200/20 rounded-lg text-xs text-yellow-100/70 hover:bg-red-800 transition">ğŸ®
                    é˜–å®¶å®‰åº·</button>
                <button onclick="setWish('æ„¿è´¢æºå¹¿è¿›ï¼Œäº‹ä¸šæ­¥æ­¥é«˜å‡ï¼Œè´µäººç›¸åŠ©')"
                    class="px-3 py-1.5 bg-red-900/30 border border-red-200/20 rounded-lg text-xs text-yellow-100/70 hover:bg-red-800 transition">ğŸ’°
                    è´¢è¿äº¨é€š</button>
                <button onclick="setWish('æ„¿å¾—ä¸€å¿ƒäººï¼Œç™½é¦–ä¸ç›¸ç¦»ï¼Œå§»ç¼˜ç¾æ»¡')"
                    class="px-3 py-1.5 bg-red-900/30 border border-red-200/20 rounded-lg text-xs text-yellow-100/70 hover:bg-red-800 transition">â¤ï¸
                    å§»ç¼˜ç¾æ»¡</button>
                <button onclick="setWish('æ„¿é€¢è€ƒå¿…è¿‡ï¼Œé‡‘æ¦œé¢˜åï¼Œå­¦ä¸šæœ‰æˆ')"
                    class="px-3 py-1.5 bg-red-900/30 border border-red-200/20 rounded-lg text-xs text-yellow-100/70 hover:bg-red-800 transition">ğŸ“
                    é‡‘æ¦œé¢˜å</button>
            </div>

            <button onclick="startRitual()"
                class="w-full btn-gold py-4 rounded-xl text-lg tracking-[0.3em] flex items-center justify-center gap-2">
                <span class="font-calligraphy text-2xl">å¼€å¯ç¥ˆç¦</span>
            </button>
        </div>

        <div id="cylinder-stage" class="hidden flex-col items-center justify-center h-80 relative w-full">
            <div id="ritual-status"
                class="absolute -top-8 text-yellow-200 font-calligraphy text-2xl animate-pulse tracking-widest z-20">
                å‡ç¥èšæ°” Â· è¯šå¿ƒæ‘‡åŠ¨...
            </div>
            <div id="bamboo-cylinder" class="bamboo-cylinder-wrapper mt-12 transform origin-bottom">
                <div class="bamboo-top"></div>
                <div class="bamboo-body">
                    <div class="bamboo-joint" style="top: 30%;"></div>
                    <div class="bamboo-joint" style="bottom: 25%;"></div>
                    <svg class="plum-decor" viewBox="0 0 100 150" overflow="visible">
                        <path d="M40 150 C40 120 60 100 20 80 C-10 60 30 40 10 10" stroke="#3e2723" stroke-width="2"
                            fill="none" opacity="0.6" />
                        <path d="M40 120 C60 110 80 130 90 100" stroke="#3e2723" stroke-width="1.5" fill="none"
                            opacity="0.5" />
                        <g fill="#c02c38" opacity="0.8">
                            <circle cx="10" cy="10" r="4" />
                            <circle cx="20" cy="80" r="3" />
                            <circle cx="90" cy="100" r="3.5" />
                        </g>
                    </svg>
                </div>
                <div id="flying-stick"
                    class="absolute -top-10 left-1/2 -translate-x-1/2 w-8 h-64 bg-[#fdfbf7] border border-[#d4c4b0] hidden z-0 flex items-start justify-center pt-4 shadow-xl rounded-t-sm"
                    style="background: linear-gradient(to right, #fdfbf7 0%, #f2e9d8 100%);">
                    <div class="absolute top-0 w-full h-4 bg-[#c02c38]"></div>
                    <span id="stick-label"
                        class="writing-vertical font-calligraphy text-[#2b2b2b] font-bold text-xl mt-6 tracking-widest">ä¸Šä¸Šç­¾</span>
                </div>
            </div>
        </div>
    </main>

    <!-- ç»“æœå¼¹çª— -->
    <div id="result-modal"
        class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/90 backdrop-blur-md hidden opacity-0 transition-opacity duration-500 p-4">
        <!-- å…³é—­æŒ‰é’® -->
        <button onclick="closeResult()"
            class="absolute top-4 right-4 p-2 text-white/50 hover:text-white transition z-50">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>

        <!-- è¯¦ç»†è§£è¯»å¼¹çª— (é»˜è®¤éšè—) -->
        <div id="detail-overlay"
            class="absolute inset-0 z-40 bg-black/80 flex items-center justify-center p-6 hidden backdrop-blur-sm transition-all duration-300">
            <div class="bg-[#b91c1c] w-full max-w-sm rounded-xl border border-yellow-500/50 p-6 shadow-2xl relative">
                <button onclick="toggleDetail()" class="absolute top-2 right-2 text-yellow-200 hover:text-white"><i
                        data-lucide="x" class="w-6 h-6"></i></button>
                <div class="text-center mb-4 border-b border-white/10 pb-2">
                    <h3 class="text-2xl font-calligraphy text-yellow-300">å¤§å¸ˆè¯¦è§£</h3>
                    <p class="text-[10px] text-yellow-100/50 uppercase tracking-widest">Fortune Interpretation</p>
                </div>
                <div id="detail-content"
                    class="text-yellow-100/90 text-sm leading-7 font-serif h-72 overflow-y-auto pr-2 text-justify no-scrollbar">
                    <!-- AI è¯¦ç»†å†…å®¹å°†å¡«å……æ­¤å¤„ -->
                </div>
            </div>
        </div>

        <!-- ä¿å­˜å›¾ç‰‡æµ®å±‚ NEW VERSION -->
        <div id="save-overlay-v2" onclick="handleOverlayClick()" data-v="3"
            class="fixed inset-0 z-[100] bg-gradient-to-b from-red-950 to-red-900 flex flex-col items-center justify-center hidden opacity-0 transition-opacity duration-300">

            <!-- å…¨å±çµç­¾å¡ç‰‡(å…‹éš†) -->
            <div id="fullscreen-card-clone" class="relative"></div>

            <!-- åº•éƒ¨æç¤º NEW - ç‚¹å‡»åéšè— -->
            <div id="save-hint"
                class="absolute bottom-12 left-0 right-0 text-center z-10 px-4 transition-opacity duration-300">
                <div
                    class="inline-block bg-black/40 backdrop-blur-sm rounded-full px-6 py-3 border border-yellow-500/30">
                    <p class="text-yellow-300 text-sm font-serif mb-1">ğŸ“¸ è¯·æˆªå±ä¿å­˜</p>
                    <p class="text-white/60 text-xs">è½»è§¦éšè—æç¤º Â· å†æ¬¡ç‚¹å‡»è¿”å›</p>
                </div>
            </div>
        </div>

        <div class="relative w-full h-full max-h-[85vh] flex items-center justify-center overflow-hidden">
            <div id="share-card-container"
                class="bg-[#b91c1c] relative shadow-2xl origin-center transition-all duration-300">
                <div class="poster-bg-texture"></div>
                <div class="poster-border-outer"></div>
                <div class="poster-border-inner"></div>
                <div class="poster-corner c-tl"></div>
                <div class="poster-corner c-tr"></div>
                <div class="poster-corner c-bl"></div>
                <div class="poster-corner c-br"></div>

                <div class="flex flex-col h-full p-8 relative z-20 share-content-main">
                    <div class="flex justify-between items-start mb-6 pt-4 px-2 header-area">
                        <div class="flex flex-col text-yellow-200/90">
                            <span class="text-[10px] tracking-[0.4em] font-serif uppercase">Fortune 2026</span>
                            <span class="text-xs font-mono opacity-80 mt-1" id="current-date">2026.01.14</span>
                        </div>
                        <div
                            class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center shadow-lg border border-yellow-200">
                            <span class="font-seal text-[#7a1a23] text-2xl pt-1">ç¦</span>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col items-center justify-center relative -mt-6 content-middle-area">
                        <div
                            class="absolute text-[180px] text-black/10 font-seal select-none pointer-events-none -z-10 bg-word-ji">
                            å‰</div>
                        <div class="mb-8 relative flex items-center justify-center level-title-area">
                            <div
                                class="w-[1px] h-20 bg-gradient-to-b from-transparent via-yellow-500/60 to-transparent mr-6 side-line">
                            </div>
                            <div class="font-calligraphy text-[4.5rem] leading-none tracking-widest text-[#fcd34d]"
                                style="text-shadow: 2px 2px 0px rgba(0,0,0,0.3);" id="poster-level">
                                <!-- JS Dynamic -->
                            </div>
                            <div
                                class="w-[1px] h-20 bg-gradient-to-b from-transparent via-yellow-500/60 to-transparent ml-6 side-line">
                            </div>
                        </div>

                        <div class="flex gap-8 justify-center h-48 mb-8 poem-container">
                            <div class="font-poem text-2xl text-yellow-50/95 leading-loose tracking-widest text-justify"
                                id="poster-poem-1"></div>
                            <div class="font-poem text-2xl text-yellow-50/95 leading-loose tracking-widest text-justify border-l border-white/20 pl-6 poem-col-2"
                                id="poster-poem-2"></div>
                        </div>

                        <div
                            class="w-full max-w-[90%] bg-[#450a0a]/40 border border-yellow-500/40 p-5 rounded-lg shadow-inner backdrop-blur-sm wish-box">
                            <div class="flex items-start gap-3 mb-3">
                                <span
                                    class="text-[10px] bg-yellow-600 font-bold text-white px-2 py-0.5 rounded flex-shrink-0">ç¥ˆæ„¿</span>
                                <div id="poster-wish" class="text-sm font-bold text-yellow-100 font-serif">
                                </div>
                            </div>
                            <div class="w-full h-[1px] bg-white/10 mb-3 divider"></div>
                            <div class="flex items-start gap-3">
                                <span
                                    class="text-[10px] bg-white/10 text-gray-300 px-2 py-0.5 rounded flex-shrink-0">å¤§å¸ˆæ›°</span>
                                <div id="poster-analysis"
                                    class="text-xs text-gray-200 leading-relaxed text-center poster-analysis">
                                    å¤§å¸ˆæ­£åœ¨æ€è€ƒ...</div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="mt-auto pt-6 pb-2 flex justify-between items-center border-t border-white/10 px-2 footer-area">
                        <div class="flex flex-col gap-1">
                            <div class="flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-4 h-4 text-yellow-500"></i>
                                <span class="font-calligraphy text-2xl text-yellow-400 footer-title">çµç­¾æŒ‡è·¯</span>
                            </div>
                            <span class="text-[9px] text-yellow-100/50 tracking-wider font-mono footer-subtitle">SCAN TO
                                GET YOUR
                                FORTUNE</span>
                        </div>
                        <div class="bg-white p-1.5 rounded-md shadow-lg qrcode-wrapper">
                            <div id="qrcode-box" class="w-14 h-14"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ai-loading-mask"
                class="absolute inset-0 bg-black/60 z-20 flex flex-col items-center justify-center text-white hidden">
                <div class="w-10 h-10 border-2 border-yellow-500 border-t-transparent rounded-full animate-spin mb-3">
                </div>
                <span class="text-sm font-serif tracking-widest text-yellow-100">å¤§å¸ˆæ­£åœ¨è§£ç­¾...</span>
            </div>
        </div>

        <div class="w-full max-w-lg mt-4 flex flex-col gap-4 z-50">
            <div class="flex justify-center gap-3">
                <button onclick="changeRatio('9-16')"
                    class="ratio-btn px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-xs text-white">9:16<br>æ‰‹æœºæµ·æŠ¥</button>
                <button onclick="changeRatio('3-4')"
                    class="ratio-btn px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-xs text-white">3:4<br>å°çº¢ä¹¦</button>
                <button onclick="changeRatio('1-1')"
                    class="ratio-btn px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-xs text-white">1:1<br>æœ‹å‹åœˆ</button>
            </div>
            <div class="flex gap-3">
                <button onclick="downloadCard()"
                    class="flex-1 btn-gold py-3.5 rounded-xl flex items-center justify-center gap-2">
                    <i data-lucide="download" class="w-5 h-5"></i> ä¿å­˜é«˜æ¸…çµç­¾
                </button>
                <button onclick="toggleDetail()"
                    class="flex-1 bg-white/10 hover:bg-white/20 text-white font-bold py-3.5 rounded-xl border border-white/20 flex items-center justify-center gap-2 backdrop-blur-sm transition">
                    <i data-lucide="book-open" class="w-5 h-5"></i> ğŸ“œ æŸ¥çœ‹è¯¦è§£
                </button>
                <button onclick="copyLink()"
                    class="px-4 bg-white/10 hover:bg-white/20 text-white rounded-xl border border-white/20 flex items-center justify-center backdrop-blur-sm"
                    title="å¤åˆ¶é“¾æ¥">
                    <i data-lucide="link" class="w-5 h-5"></i>
                </button>
                <button onclick="closeResult()"
                    class="px-4 bg-white/10 text-white font-bold py-3.5 rounded-xl border border-white/20">è¿”å›</button>
            </div>
        </div>
    </div>

    <!-- å·¦ä¸‹è§’ UI -->
    <div class="bottom-ui">
        <div id="user-pill" class="user-pill group" ondblclick="resetTrials()" title="åŒå‡»é‡ç½®è¯•ç©æ¬¡æ•°">
            <div
                class="w-6 h-6 rounded-full bg-yellow-500 text-red-900 flex items-center justify-center font-bold text-xs">
                <span>å®¢</span>
            </div>
            <div class="flex flex-col leading-tight">
                <span class="font-bold text-white">æ¸¸å®¢è¯•ç©</span>
                <span class="text-yellow-400/80 scale-90 origin-left" id="user-trials">å‰©ä½™æ¬¡æ•°: 2</span>
            </div>
        </div>
        <div
            class="w-8 h-8 rounded-full bg-black/30 backdrop-blur flex items-center justify-center text-white/70 hover:bg-black/50 hover:text-white transition cursor-pointer">
            <i data-lucide="home" class="w-4 h-4"></i>
        </div>
    </div>

    <script>
        const state = {
            currentWish: '',
            currentRatio: '1-1',
            trials: 0
        };

        const FORTUNES_MAP = {
            1: { level: "ä¸Šä¸Šç­¾", poem: "å½©å‡¤å‘ˆç¥¥ç‘æ°”é£˜|é¾™è…¾è™è·ƒä¸Šäº‘éœ„" },
            2: { level: "ä¸Šå‰ç­¾", poem: "æ˜¥æ¥èŠ±å‘æ˜ é˜³å°|ä¸‡é‡Œè½¦ä¹¦å°½å¾—é€š" },
            3: { level: "ä¸­å‰ç­¾", poem: "æ ¹æ·±å¶èŒ‚å¾…æ˜¥é£|ä¸€ä¸¾æˆååœ¨å…¶ä¸­" }
        };

        window.addEventListener('load', () => {
            lucide.createIcons();
            createSnow();
            generateQRCode();
            changeRatio('1-1');
            document.getElementById('current-date').innerText = new Date().toISOString().slice(0, 10).replace(/-/g, '.');

            // åˆå§‹åŒ–è¯•ç©æ¬¡æ•°
            state.trials = parseInt(localStorage.getItem('qifu_trials') || '0');
            updateTrialsUI();
        });

        function updateTrialsUI() {
            const btnStart = document.querySelector('button[onclick="startRitual()"]');
            if (state.trials >= 2) {
                document.getElementById('user-trials').innerText = `æ¬¡æ•°å·²ç”¨å°½`;
                if (btnStart) {
                    btnStart.disabled = true;
                    btnStart.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else {
                document.getElementById('user-trials').innerText = `å‰©ä½™æ¬¡æ•°: ${2 - state.trials}`;
                if (btnStart) {
                    btnStart.disabled = false;
                    btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        function resetTrials() {
            state.trials = 0;
            localStorage.setItem('qifu_trials', '0');
            updateTrialsUI();
            console.log('âœ… è¯•ç©æ¬¡æ•°å·²é‡ç½®');
        }

        function createSnow() {
            const container = document.getElementById('snow-container');
            for (let i = 0; i < 30; i++) {
                const el = document.createElement('div');
                el.className = 'fixed top-0 text-white opacity-40 pointer-events-none';
                el.innerText = 'â„';
                el.style.left = Math.random() * 100 + 'vw';
                el.style.animation = `fall ${Math.random() * 10 + 5}s linear infinite`;
                el.style.fontSize = Math.random() * 10 + 5 + 'px';
                container.appendChild(el);
            }
            const style = document.createElement('style');
            style.innerHTML = `@keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }`;
            document.head.appendChild(style);
        }

        function setWish(text) { document.getElementById('wish-input').value = text; }

        function generateQRCode() {
            new QRCode(document.getElementById("qrcode-box"), {
                text: window.location.href,
                width: 56, height: 56,
                colorDark: "#b91c1c", colorLight: "#ffffff"
            });
        }

        function startRitual() {
            if (state.trials >= 2) return alert("è¯•ç©æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·æ³¨å†Œç™»å½•ã€‚");

            const wish = document.getElementById('wish-input').value.trim();
            if (!wish) return alert("è¯·å…ˆå†™ä¸‹æ‚¨çš„æ„¿æœ›");
            state.currentWish = wish;

            // æ‰£é™¤æ¬¡æ•°
            state.trials++;
            localStorage.setItem('qifu_trials', state.trials);
            updateTrialsUI();

            document.getElementById('input-box').classList.add('hidden');
            document.getElementById('cylinder-stage').classList.remove('hidden');
            document.getElementById('cylinder-stage').classList.add('flex');

            const cylinder = document.getElementById('bamboo-cylinder');
            cylinder.classList.add('animate-shake-hard');

            setTimeout(() => {
                cylinder.classList.remove('animate-shake-hard');
                const stickId = Math.floor(Math.random() * 3) + 1;
                const fortune = FORTUNES_MAP[stickId];

                const stick = document.getElementById('flying-stick');
                document.getElementById('stick-label').innerText = fortune.level;
                stick.classList.remove('hidden');
                stick.classList.add('stick-appear');

                setTimeout(() => showResult(fortune), 2000);
            }, 3000);
        }

        function renderVerticalText(elId, text) {
            const el = document.getElementById(elId);
            el.innerHTML = '';
            for (let char of text) {
                const span = document.createElement('span');
                span.innerText = char;
                span.style.display = 'block';
                el.appendChild(span);
            }
        }

        async function showResult(fortune) {
            // 1. å…ˆæ›´æ–°é™æ€æ•°æ® (åœ¨æ˜¾ç¤ºModalä¹‹å‰)
            document.getElementById('poster-wish').innerText = state.currentWish;
            renderVerticalText('poster-level', fortune.level);
            const lines = fortune.poem.split('|');
            renderVerticalText('poster-poem-1', lines[0]);
            renderVerticalText('poster-poem-2', lines[1]);

            // 2. é‡ç½®åŠ¨æ€åŒºåŸŸåŠLoadingçŠ¶æ€
            const posterAnalysis = document.getElementById('poster-analysis');
            const detailContent = document.getElementById('detail-content');

            posterAnalysis.innerText = 'å¤§å¸ˆæ­£åœ¨æ€è€ƒ...';
            detailContent.innerText = '';

            const loadingMask = document.getElementById('ai-loading-mask');
            loadingMask.classList.remove('hidden');
            loadingMask.querySelector('span').innerText = "å¤§å¸ˆæ­£åœ¨è§£ç­¾...";

            // 3. æ˜¾ç¤º modal (æ­¤æ—¶å†…å®¹å·²æ˜¯æ–°çš„)
            const modal = document.getElementById('result-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.style.opacity = '1', 10);

            // éšè—å·¦ä¸‹è§’ UI é¿å…é®æŒ¡
            document.querySelector('.bottom-ui').style.display = 'none';

            // å»¶è¿Ÿåº”ç”¨æ¯”ä¾‹,ç¡®ä¿å®¹å™¨å·²æ¸²æŸ“
            setTimeout(() => {
                changeRatio(state.currentRatio);
            }, 100);

            let fullTextBuffer = '';

            // è°ƒç”¨æµå¼ API
            await streamFortuneAI(state.currentWish, fortune, {
                onContent: (text) => {
                    loadingMask.classList.add('hidden');
                    fullTextBuffer += text;

                    const shortMarker = 'ã€ç®€çŸ­å¯„è¯­ã€‘';
                    const fullMarker = 'ã€è¯¦ç»†è§£ç­¾ã€‘';

                    let shortText = '';
                    let fullAnalysisText = '';

                    const shortIndex = fullTextBuffer.indexOf(shortMarker);
                    const fullIndex = fullTextBuffer.indexOf(fullMarker);

                    if (shortIndex !== -1 && fullIndex !== -1) {
                        shortText = fullTextBuffer.substring(shortIndex + shortMarker.length, fullIndex).trim();
                        fullAnalysisText = fullTextBuffer.substring(fullIndex + fullMarker.length).trim();
                    } else if (shortIndex !== -1) {
                        shortText = fullTextBuffer.substring(shortIndex + shortMarker.length).trim();
                    } else if (fullIndex !== -1) {
                        fullAnalysisText = fullTextBuffer.substring(fullIndex + fullMarker.length).trim();
                    }

                    if (shortText) posterAnalysis.innerText = shortText;
                    if (fullAnalysisText) detailContent.innerText = fullAnalysisText;
                },
                onDone: () => {
                    console.log('AI Generation Complete');
                },
                onError: (err) => {
                    console.error('AI Stream Error:', err);
                    loadingMask.classList.add('hidden');
                    posterAnalysis.innerText = 'å¤§å¸ˆæ­£åœ¨ä¼‘æ¯,è¯·ç¨åé‡è¯•';
                }
            });
        }

        function toggleDetail() {
            const overlay = document.getElementById('detail-overlay');
            if (overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                overlay.classList.add('hidden');
            }
        }

        async function copyLink() {
            const level = document.getElementById('poster-level').innerText.replace(/\s/g, '');
            const wish = state.currentWish;
            const shareText = `æˆ‘åœ¨ã€çµç­¾æŒ‡è·¯ã€‘æ±‚äº†ä¸€æ”¯${level}ï¼æ„¿æœ›ï¼š${wish}\nå¿«æ¥æµ‹æµ‹ä½ çš„2026è¿åŠ¿å§ï¼š${window.location.href}`;

            try {
                await navigator.clipboard.writeText(shareText);
                alert("é“¾æ¥åŠåˆ†äº«æ–‡æ¡ˆå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
            } catch (err) {
                const textArea = document.createElement("textarea");
                textArea.value = shareText;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert("é“¾æ¥åŠåˆ†äº«æ–‡æ¡ˆå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
                } catch (e) {
                    alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æµè§ˆå™¨åœ°å€æ é“¾æ¥ã€‚");
                }
                document.body.removeChild(textArea);
            }
        }

        function changeRatio(ratio) {
            state.currentRatio = ratio;  // æ›´æ–°çŠ¶æ€
            const container = document.getElementById('share-card-container');

            // å…ˆç§»é™¤æ‰€æœ‰æ¯”ä¾‹ç±»
            container.className = 'bg-[#b91c1c] relative shadow-2xl origin-center transition-all duration-300';

            // å¼ºåˆ¶é‡ç»˜
            container.offsetHeight;

            // åº”ç”¨æ–°æ¯”ä¾‹
            container.classList.add(`share-ratio-${ratio}`);

            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM å·²æ›´æ–°
            requestAnimationFrame(() => {
                const scale = Math.min(
                    window.innerWidth / container.offsetWidth * 0.85,
                    window.innerHeight / container.offsetHeight * 0.65
                );
                container.style.transform = `scale(${scale})`;
            });
        }

        function closeResult() {
            const modal = document.getElementById('result-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('input-box').classList.remove('hidden');
                document.getElementById('cylinder-stage').classList.add('hidden');
                document.getElementById('flying-stick').classList.add('hidden');
                // æ¢å¤å·¦ä¸‹è§’ UI
                document.querySelector('.bottom-ui').style.display = 'flex';
                // æ¸…ç©ºå†…å®¹ä»¥é˜²æ®‹å½±
                document.getElementById('poster-analysis').innerText = '';
                document.getElementById('detail-content').innerText = '';
            }, 300);

            // åœæ­¢å¯èƒ½çš„è¯­éŸ³æ’­æ”¾(å¦‚æœæœ‰çš„é€»è¾‘)
            // ...
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                || window.innerWidth <= 768;
        }

        function downloadCard() {
            if (isMobile()) {
                showFullscreenCard();
            } else {
                // PCç«¯: æ¢å¤ä½¿ç”¨çº¯å‰ç«¯ html2canvas ä¸‹è½½ (é€Ÿåº¦æ›´å¿«)
                downloadCardPC();
            }
        }

        function showImageOverlay(imageUrl) {
            const overlay = document.getElementById('save-overlay-v2');
            const cloneContainer = document.getElementById('fullscreen-card-clone');

            cloneContainer.innerHTML = `<img src="${imageUrl}" class="w-full h-auto rounded-lg shadow-2xl" style="max-height: 80vh; object-fit: contain;">`;

            document.getElementById('save-hint-text').innerText = "é•¿æŒ‰å›¾ç‰‡ä¿å­˜ Â· è½¬å‘ç»™å¥½å‹";

            overlay.classList.remove('hidden');
            setTimeout(() => overlay.style.opacity = '1', 10);
        }

        function showFullscreenCard() {
            const overlay = document.getElementById('save-overlay-v2');
            const cloneContainer = document.getElementById('fullscreen-card-clone');
            const originalCard = document.getElementById('share-card-container');

            // å…‹éš†çµç­¾å¡ç‰‡
            const cardClone = originalCard.cloneNode(true);
            cardClone.id = 'cloned-card';
            cardClone.style.transform = 'none'; // ç§»é™¤åŸå§‹transform

            // æ¸…ç©ºä¹‹å‰çš„å…‹éš†
            cloneContainer.innerHTML = '';
            cloneContainer.appendChild(cardClone);

            // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMå·²æ¸²æŸ“
            requestAnimationFrame(() => {
                // è®¡ç®—åˆé€‚çš„ç¼©æ”¾æ¯”ä¾‹,ä¸ºåº•éƒ¨æç¤ºé¢„ç•™ç©ºé—´
                const maxWidth = window.innerWidth * 0.85;
                const maxHeight = window.innerHeight * 0.65; // é™ä½é«˜åº¦æ¯”ä¾‹,ä¸ºæç¤ºé¢„ç•™ç©ºé—´
                const cardWidth = cardClone.offsetWidth;
                const cardHeight = cardClone.offsetHeight;

                const scale = Math.min(
                    maxWidth / cardWidth,
                    maxHeight / cardHeight,
                    1.15  // å¢å¤§åˆ° 1.15ï¼Œè®©å¡ç‰‡æ›´å¤§
                );

                cardClone.style.transform = `scale(${scale})`;
                cardClone.style.transformOrigin = 'center center';
                cardClone.style.boxShadow = '0 30px 80px rgba(0,0,0,0.6)';
            });

            // æ˜¾ç¤ºæµ®å±‚
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.style.opacity = '1', 10);
        }

        function downloadCardPC() {
            const container = document.getElementById('share-card-container');
            const loadingMask = document.getElementById('ai-loading-mask');

            loadingMask.classList.remove('hidden');
            loadingMask.querySelector('span').innerText = "æ­£åœ¨ç”Ÿæˆé«˜æ¸…æµ·æŠ¥...";

            // ä¿å­˜åŸå§‹æ ·å¼
            const originalTransform = container.style.transform;
            const originalOverflow = container.style.overflow;

            // ä¸´æ—¶ç§»é™¤æ–‡å­—æˆªæ–­é™åˆ¶
            const wish = document.getElementById('poster-wish');
            const analysis = document.getElementById('poster-analysis');
            const originalWishStyle = wish.style.cssText;
            const originalAnalysisStyle = analysis.style.cssText;

            wish.style.display = 'block';
            wish.style.webkitLineClamp = 'unset';
            wish.style.overflow = 'visible';
            analysis.style.display = 'block';
            analysis.style.webkitLineClamp = 'unset';
            analysis.style.overflow = 'visible';

            // ç§»é™¤transform,è®©å®¹å™¨æ¢å¤åŸå§‹å°ºå¯¸,å¹¶ç¡®ä¿ä¸è£å‰ªè¾¹æ¡†
            container.style.transform = 'scale(1)';
            container.style.overflow = 'visible';

            // ç­‰å¾…æµè§ˆå™¨é‡ç»˜
            setTimeout(() => {
                html2canvas(container, {
                    scale: 2,
                    backgroundColor: '#b91c1c',
                    logging: false,
                    allowTaint: true,
                    useCORS: false,
                    x: -5,  // å‘å·¦æ‰©å±•5px
                    y: -5,  // å‘ä¸Šæ‰©å±•5px
                    width: container.offsetWidth + 10,  // å®½åº¦å¢åŠ 10px
                    height: container.offsetHeight + 10  // é«˜åº¦å¢åŠ 10px
                }).then(canvas => {
                    // æ¢å¤æ‰€æœ‰æ ·å¼
                    container.style.transform = originalTransform;
                    container.style.overflow = originalOverflow;
                    wish.style.cssText = originalWishStyle;
                    analysis.style.cssText = originalAnalysisStyle;

                    const link = document.createElement('a');
                    link.download = `ç¥ˆç¦çµç­¾_${new Date().getTime()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    loadingMask.classList.add('hidden');
                }).catch(err => {
                    // æ¢å¤æ‰€æœ‰æ ·å¼
                    container.style.transform = originalTransform;
                    container.style.overflow = originalOverflow;
                    wish.style.cssText = originalWishStyle;
                    analysis.style.cssText = originalAnalysisStyle;

                    console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', err);
                    loadingMask.classList.add('hidden');
                    alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥,è¯·é‡è¯•\né”™è¯¯: ' + (err.message || 'æœªçŸ¥é”™è¯¯'));
                });
            }, 100);
        }

        function handleOverlayClick() {
            const hint = document.getElementById('save-hint');
            if (hint && hint.style.opacity !== '0') {
                // ç¬¬ä¸€æ¬¡ç‚¹å‡»:éšè—æç¤º
                hint.style.opacity = '0';
                setTimeout(() => hint.style.display = 'none', 300);
            } else {
                // ç¬¬äºŒæ¬¡ç‚¹å‡»:å…³é—­æµ®å±‚
                closeSaveModal();
            }
        }

        function closeSaveModal() {
            const overlay = document.getElementById('save-overlay-v2');
            overlay.style.opacity = '0';
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }
    </script>
</body>

</html>